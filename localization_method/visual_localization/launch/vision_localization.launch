<launch>

    <arg name="stereo" default="true" />
    <arg if="$(arg stereo)" name="depth" default="false" />
    <arg unless="$(arg stereo)" name="depth" default="true" />

    <!-- Choose visualization -->
    <arg name="rtabmapviz" default="false" />
    <arg name="rviz" default="false" />

    <!-- Localization-only mode -->
    <arg name="localization" default="true" />

    <!-- sim time for convenience, if playing a rosbag -->
    <arg name="use_sim_time" default="true" />
    <param if="$(arg use_sim_time)" name="use_sim_time" value="true" />

    <!-- Corresponding config files -->
    <!-- <arg name="cfg" default="$(find stereo_odometry)/config/config.ini" /> To change RTAB-Map's parameters, set the path of config file (*.ini) generated by the standalone app -->
    <arg name="cfg" default="$(find visual_localization)/config/libraryconfig.ini" /> <!-- To change RTAB-Map's parameters, set the path of config file (*.ini) generated by the standalone app -->
    <arg name="gui_cfg" default="$(find visual_localization)/config/libraryconfig.ini" />
    <arg name="rviz_cfg" default="$(find rtabmap_ros)/launch/config/rgbd.rviz" />

    <arg name="frame_id" default="base_link" /> <!-- Fixed frame id, you may set "base_link" or "base_footprint" if they are published -->
    <arg name="odom_frame_id" default="" /> <!-- If set, TF is used to get odometry instead of the topic -->
    <arg name="map_frame_id" default="map" />
    <arg name="ground_truth_frame_id" default="" /> <!-- e.g., "world" -->
    <arg name="ground_truth_base_frame_id" default="" /> <!-- e.g., "tracker", a fake frame matching the frame "frame_id" (but on different TF tree) -->
    <arg name="namespace" default="rtabmap" />
    <arg name="database_path" default="$(find visual_localization)/map/library.db" />
    <arg name="queue_size" default="10" />
    <arg name="wait_for_transform" default="0.2" />
    <arg name="args" default="" /> <!-- delete_db_on_start, udebug -->
    <arg name="rtabmap_args" default="$(arg args)" /> <!-- deprecated, use "args" argument -->
    <arg name="launch_prefix" default="" /> <!-- for debugging purpose, it fills launch-prefix tag of the nodes -->
    <arg name="output" default="screen" /> <!-- Control node output (screen or log) -->
    <arg name="publish_tf_map" default="true" />

    <arg name="approx_sync" default="true" /> <!-- if timestamps of the input topics are not synchronized -->

    <!-- stereo related topics -->
    <arg name="stereo_namespace" default="/wide_stereo" />
    <arg name="left_image_topic" default="$(arg stereo_namespace)/left/image_color" />
    <arg name="right_image_topic" default="$(arg stereo_namespace)/right/image_color" /> <!-- using grayscale image for efficiency -->
    <arg name="left_camera_info_topic" default="$(arg stereo_namespace)/left/camera_info" />
    <arg name="right_camera_info_topic" default="$(arg stereo_namespace)/right/camera_info" />


    <arg name="subscribe_scan" default="true" />
    <arg name="scan_topic" default="/front/scan" />
    <arg name="subscribe_scan_cloud" default="false" />
    <arg name="scan_cloud_topic" default="" />
    <arg name="subscribe_scan_descriptor" default="false" />
    <arg name="scan_descriptor_topic" default="/scan_descriptor" />
    <arg name="scan_cloud_max_points" default="0" />
    <arg name="scan_cloud_filtered" default="false" /> <!-- use filtered cloud from icp_odometry for mapping -->

    <arg name="odom_topic" default="/boxer_velocity_controller/odom" /> <!-- Odometry topic name -->
    <!-- <arg name="odom_topic" default="/vio_odom" /> -->
    <arg name="vo_frame_id" default="odom" /> <!-- Visual/Icp odometry frame ID for TF -->
    <arg name="publish_tf_odom" default="false" />
    <arg name="odom_tf_angular_variance" default="1" /> <!-- If TF is used to get odometry, this is the default angular variance -->
    <arg name="odom_tf_linear_variance" default="1" /> <!-- If TF is used to get odometry, this is the default linear variance -->
    <arg name="odom_args" default="" /> <!-- More arguments for odometry (overwrite same parameters in rtabmap_args) -->
    <arg name="odom_sensor_sync" default="false" />
    <arg name="odom_guess_frame_id" default="" />
    <arg name="odom_guess_min_translation" default="0" />
    <arg name="odom_guess_min_rotation" default="0" />
    <arg name="imu_topic" default="/imu" /> <!-- only used with VIO approaches -->
    <arg name="wait_imu_to_init" default="true" />


    <!-- Nodes -->
    <group ns="$(arg namespace)">

        <!-- Visual SLAM (robot side) -->
        <!-- args: "delete_db_on_start" and "udebug" -->
        <node name="rtabmap" pkg="rtabmap_ros" type="rtabmap" output="$(arg output)" args="$(arg rtabmap_args)" launch-prefix="$(arg launch_prefix)">
            <param if="$(arg stereo)" name="subscribe_depth" type="bool" value="false" />
            <param name="Reg/Force3DoF"    value="true" />
            <param name="Optimizer/Slam2D" value="true" />
            <param name="grid_size" type="double" value="50"/> <!-- 50 meters wide -->
            <param name="cloud_noise_filtering_radius" value="0.05"/>
            <param name="cloud_noise_filtering_min_neighbors" value="2"/>
            <param unless="$(arg stereo)" name="subscribe_depth" type="bool" value="$(arg depth)" />
            <param name="subscribe_stereo" type="bool" value="$(arg stereo)" />
            <param name="frame_id" type="string" value="$(arg frame_id)" />
            <param name="map_frame_id" type="string" value="$(arg map_frame_id)" />
            <param name="odom_frame_id" type="string" value="$(arg odom_frame_id)" />
            <param name="publish_tf" type="bool" value="$(arg publish_tf_map)" />
            <param name="odom_tf_angular_variance" type="double" value="$(arg odom_tf_angular_variance)" />
            <param name="odom_tf_linear_variance" type="double" value="$(arg odom_tf_linear_variance)" />
            <param name="odom_sensor_sync" type="bool" value="$(arg odom_sensor_sync)" />
            <param name="wait_for_transform_duration" type="double" value="$(arg wait_for_transform)" />
            <param name="database_path" type="string" value="$(arg database_path)" />
            <param name="approx_sync" type="bool" value="$(arg approx_sync)" />
            <param name="config_path" type="string" value="$(arg cfg)" />
            <param name="queue_size" type="int" value="$(arg queue_size)" />
            <param name="scan_cloud_max_points" type="int" value="$(arg scan_cloud_max_points)" />


            <remap from="left/image_rect" to="$(arg left_image_topic)" />
            <remap from="right/image_rect" to="$(arg right_image_topic)" />
            <remap from="left/camera_info" to="$(arg left_camera_info_topic)" />
            <remap from="right/camera_info" to="$(arg right_camera_info_topic)" />
            <remap from="odom" to="$(arg odom_topic)" />
            <remap from="imu" to="$(arg imu_topic)" />

            <!-- localization mode -->
            <param if="$(arg localization)" name="Mem/IncrementalMemory" type="string" value="false" />
            <param unless="$(arg localization)" name="Mem/IncrementalMemory" type="string" value="true" />
            <param name="Mem/InitWMWithAllNodes" type="string" value="$(arg localization)" />
        </node>

        <!-- Visualisation RTAB-Map -->
        <node if="$(arg rtabmapviz)" pkg="rtabmap_ros" type="rtabmapviz" name="rtabmapviz" args="-d $(arg gui_cfg)" output="$(arg output)" launch-prefix="$(arg launch_prefix)">
            <param if="$(arg stereo)" name="subscribe_depth" type="bool" value="false" />
            <param unless="$(arg stereo)" name="subscribe_depth" type="bool" value="$(arg depth)" />
            <param name="subscribe_stereo" type="bool" value="$(arg stereo)" />
            <param name="frame_id" type="string" value="$(arg frame_id)" />
            <param name="odom_frame_id" type="string" value="$(arg odom_frame_id)" />
            <param name="wait_for_transform_duration" type="double" value="$(arg wait_for_transform)" />
            <param name="queue_size" type="int" value="$(arg queue_size)" />
            <param name="approx_sync" type="bool" value="$(arg approx_sync)" />

            <remap from="left/image_rect" to="$(arg left_image_topic)" />
            <remap from="right/image_rect" to="$(arg right_image_topic)" />
            <remap from="left/camera_info" to="$(arg left_camera_info_topic)" />
            <remap from="right/camera_info" to="$(arg right_camera_info_topic)" />

            <remap from="odom" to="$(arg odom_topic)" />
        </node>

    </group>

    <!-- Visualization RVIZ -->
    <node if="$(arg rviz)" pkg="rviz" type="rviz" name="rviz" args="-d $(arg rviz_cfg)" />
    <node if="$(arg rviz)" pkg="nodelet" type="nodelet" name="points_xyzrgb" args="standalone rtabmap_ros/point_cloud_xyzrgb" output="$(arg output)">
        <remap if="$(arg stereo)" from="left/image" to="$(arg left_image_topic)" />
        <remap if="$(arg stereo)" from="right/image" to="$(arg right_image_topic)" />
        <remap if="$(arg stereo)" from="left/camera_info" to="$(arg left_camera_info_topic)" />
        <remap if="$(arg stereo)" from="right/camera_info" to="$(arg right_camera_info_topic)" />
        <remap from="cloud" to="voxel_cloud" />

        <param name="decimation" type="double" value="4" />
        <param name="voxel_size" type="double" value="0.0" />
        <param name="approx_sync" type="bool" value="$(arg approx_sync)" />
    </node>

</launch>
